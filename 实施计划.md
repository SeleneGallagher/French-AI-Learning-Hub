# å®æ–½è®¡åˆ’ - è¯¦ç»†æ­¥éª¤

## ğŸ“ æ¨¡å—å®æ–½é¡ºåº

### æ¨¡å—1: å…³äºæ¨¡å— (æœ€ç®€å•ï¼Œå…ˆåš)

#### å‰ç«¯éƒ¨åˆ†
**æ–‡ä»¶**: `scripts/modules/about.js`
```javascript
export function initAbout() {
    // æ˜¾ç¤ºå…³äºä¿¡æ¯
    // ä¸éœ€è¦APIè°ƒç”¨ï¼Œçº¯é™æ€å†…å®¹
}
```

**HTMLéƒ¨åˆ†** (åœ¨index.htmlä¸­æ·»åŠ ):
```html
<section id="about" class="module hidden p-8">
    <h2 class="text-3xl font-bold mb-6">â„¹ï¸ å…³äº</h2>
    <div class="space-y-6">
        <!-- é¡¹ç›®ç®€ä»‹ -->
        <!-- ä½¿ç”¨çš„APIå’Œèµ„æºåˆ—è¡¨ -->
        <!-- æŠ€æœ¯æ ˆ -->
    </div>
</section>
```

**å¯¼èˆªæ ä¿®æ”¹**:
- ç§»é™¤å·¦ä¸‹è§’ "Powered by Coze AI"
- æ·»åŠ å¯¼èˆªé¡¹ "â„¹ï¸ å…³äº"

---

### æ¨¡å—2: åç«¯åŸºç¡€æ¶æ„

#### 2.1 åˆ›å»ºFlaské¡¹ç›®ç»“æ„
```
backend/
â”œâ”€â”€ app.py                 # ä¸»åº”ç”¨
â”œâ”€â”€ config.py              # é…ç½®æ–‡ä»¶
â”œâ”€â”€ models.py              # æ•°æ®åº“æ¨¡å‹
â”œâ”€â”€ auth.py                # è®¤è¯ç›¸å…³è·¯ç”±
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ dictionary.py      # è¯å…¸API
â”‚   â”œâ”€â”€ expressions.py     # è¯­ç”¨API
â”‚   â”œâ”€â”€ ai.py              # AIåŠ©æ‰‹API
â”‚   â”œâ”€â”€ news.py            # æ–°é—»ä»£ç†
â”‚   â””â”€â”€ movies.py          # å½±è§†ä»£ç†
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ coze_service.py    # Coze APIä»£ç†
â”‚   â”œâ”€â”€ deepseek_service.py # DeepSeek APIä»£ç†
â”‚   â”œâ”€â”€ tmdb_service.py    # TMDB APIä»£ç†
â”‚   â””â”€â”€ news_service.py    # æ–°é—»æŠ“å–
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ db.py              # æ•°æ®åº“å·¥å…·
â”‚   â””â”€â”€ jwt_utils.py       # JWTå·¥å…·
â””â”€â”€ requirements.txt
```

#### 2.2 æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
```python
# backend/utils/init_db.py
def init_database():
    # åˆ›å»ºæ‰€æœ‰è¡¨
    # æ’å…¥é»˜è®¤æ³¨å†Œç 
    # åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·ï¼ˆå¯é€‰ï¼‰
```

#### 2.3 é…ç½®æ–‡ä»¶
```python
# backend/config.py
class Config:
    SECRET_KEY = 'your-secret-key'
    DATABASE_URL = 'sqlite:///french_ai.db'
    JWT_SECRET_KEY = 'jwt-secret-key'
    JWT_EXPIRATION = 86400  # 24å°æ—¶
    
    # API Keys (ä»ç¯å¢ƒå˜é‡è¯»å–)
    DEEPSEEK_API_KEY = os.getenv('DEEPSEEK_API_KEY', '')
    COZE_BOT_ID = os.getenv('COZE_BOT_ID', '')
    COZE_ACCESS_TOKEN = os.getenv('COZE_ACCESS_TOKEN', '')
    TMDB_API_KEY = os.getenv('TMDB_API_KEY', '')
    
    # æ³¨å†Œç 
    REGISTRATION_CODE = 'YOUR_REGISTRATION_CODE'  # å¯ä»¥æ”¹ä¸ºä»æ•°æ®åº“è¯»å–
```

---

### æ¨¡å—3: ç”¨æˆ·è®¤è¯ç³»ç»Ÿ

#### 3.1 æ³¨å†ŒåŠŸèƒ½
**åç«¯**: `backend/auth.py`
```python
@app.route('/api/v1/auth/register', methods=['POST'])
def register():
    data = request.json
    username = data.get('username')
    password = data.get('password')
    reg_code = data.get('registration_code')
    
    # 1. éªŒè¯æ³¨å†Œç 
    if not verify_registration_code(reg_code):
        return jsonify({'success': False, 'message': 'æ³¨å†Œç æ— æ•ˆ'}), 400
    
    # 2. æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨
    if User.query.filter_by(username=username).first():
        return jsonify({'success': False, 'message': 'ç”¨æˆ·åå·²å­˜åœ¨'}), 400
    
    # 3. åˆ›å»ºç”¨æˆ·
    password_hash = bcrypt.hashpw(password.encode(), bcrypt.gensalt())
    user = User(username=username, password_hash=password_hash)
    db.session.add(user)
    
    # 4. æ ‡è®°æ³¨å†Œç ä¸ºå·²ä½¿ç”¨
    mark_registration_code_used(reg_code, user.id)
    
    db.session.commit()
    
    # 5. ç”ŸæˆJWT Token
    token = generate_jwt_token(user.id)
    
    return jsonify({
        'success': True,
        'token': token,
        'user': {'id': user.id, 'username': user.username}
    })
```

**å‰ç«¯**: `scripts/modules/login.js`
```javascript
async function handleRegister(username, password, regCode) {
    try {
        const response = await fetch('/api/v1/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password, registration_code: regCode })
        });
        const data = await response.json();
        if (data.success) {
            AuthService.setToken(data.token);
            // åŠ è½½ç”¨æˆ·æ•°æ®
            await loadUserData();
            // åˆ‡æ¢åˆ°ä¸»ç•Œé¢
            window.location.hash = '#news';
        } else {
            alert(data.message);
        }
    } catch (error) {
        console.error('æ³¨å†Œå¤±è´¥:', error);
    }
}
```

#### 3.2 ç™»å½•åŠŸèƒ½
ç±»ä¼¼æ³¨å†Œï¼Œä½†ä¸éœ€è¦æ³¨å†Œç 

#### 3.3 ç™»å½•ç•Œé¢UI
```html
<section id="login" class="module p-8">
    <div class="max-w-md mx-auto">
        <h2 class="text-3xl font-bold mb-6">ç™»å½• / æ³¨å†Œ</h2>
        
        <!-- ç™»å½•è¡¨å• -->
        <div id="login-form" class="space-y-4">
            <input type="text" id="login-username" placeholder="ç”¨æˆ·å">
            <input type="password" id="login-password" placeholder="å¯†ç ">
            <button id="login-btn">ç™»å½•</button>
            <button id="show-register-btn">æ²¡æœ‰è´¦å·ï¼Ÿæ³¨å†Œ</button>
        </div>
        
        <!-- æ³¨å†Œè¡¨å• -->
        <div id="register-form" class="hidden space-y-4">
            <input type="text" id="register-username" placeholder="ç”¨æˆ·å">
            <input type="password" id="register-password" placeholder="å¯†ç ">
            <input type="text" id="register-code" placeholder="æ³¨å†Œç ">
            <button id="register-btn">æ³¨å†Œ</button>
            <button id="show-login-btn">å·²æœ‰è´¦å·ï¼Ÿç™»å½•</button>
        </div>
    </div>
</section>
```

---

### æ¨¡å—4: è¯å…¸æ¨¡å—æ”¹é€ 

#### 4.1 æ•°æ®å­˜å‚¨è¿ç§»
**åŸä»£ç ** (ä½¿ç”¨localStorage):
```javascript
// æ—§ä»£ç 
localStorage.setItem('dict_history', JSON.stringify(history));
```

**æ–°ä»£ç ** (ä½¿ç”¨åç«¯API):
```javascript
// æ–°ä»£ç 
import { APIService } from '../services/apiService.js';

// ä¿å­˜æŸ¥è¯¢å†å²
async function saveSearchHistory(word) {
    try {
        await APIService.addDictHistory(word);
    } catch (error) {
        console.error('ä¿å­˜å†å²å¤±è´¥:', error);
    }
}

// åŠ è½½æŸ¥è¯¢å†å²
async function loadSearchHistory() {
    try {
        const response = await APIService.getDictHistory();
        return response.data || [];
    } catch (error) {
        console.error('åŠ è½½å†å²å¤±è´¥:', error);
        return [];
    }
}
```

#### 4.2 åç«¯APIå®ç°
```python
# backend/routes/dictionary.py
@app.route('/api/v1/dictionary/history', methods=['GET'])
@require_auth
def get_dict_history():
    user_id = get_current_user_id()
    history = DictHistory.query.filter_by(user_id=user_id)\
        .order_by(DictHistory.searched_at.desc())\
        .limit(50).all()
    
    return jsonify({
        'success': True,
        'data': [{
            'id': h.id,
            'word': h.word,
            'searched_at': h.searched_at.isoformat()
        } for h in history]
    })

@app.route('/api/v1/dictionary/history', methods=['POST'])
@require_auth
def add_dict_history():
    user_id = get_current_user_id()
    word = request.json.get('word')
    
    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ï¼ˆé¿å…é‡å¤ï¼‰
    existing = DictHistory.query.filter_by(
        user_id=user_id, word=word
    ).first()
    
    if not existing:
        history = DictHistory(user_id=user_id, word=word)
        db.session.add(history)
        db.session.commit()
    
    return jsonify({'success': True})
```

---

### æ¨¡å—5: è¯­ç”¨æ¨¡å—æ”¹é€ 

#### 5.1 ä¿å­˜è¡¨è¾¾è®°å½•
**åŸä»£ç **: ä½¿ç”¨IndexedDB
**æ–°ä»£ç **: ä½¿ç”¨åç«¯API

```javascript
// ä¿å­˜ç”Ÿæˆçš„è¡¨è¾¾
async function saveExpression(scenario, expressionData) {
    await APIService.createExpression({
        scenario,
        expression_data: expressionData
    });
}
```

#### 5.2 åŠ è½½ç”¨æˆ·è¡¨è¾¾è®°å½•
```javascript
async function loadUserExpressions() {
    const response = await APIService.getExpressions();
    return response.data || [];
}
```

---

### æ¨¡å—6: AIåŠ©æ‰‹æ¨¡å—æ”¹é€ 

#### 6.1 ä»£ç†Coze API
**åŸä»£ç **: å‰ç«¯ç›´æ¥è°ƒç”¨Coze API
**æ–°ä»£ç **: é€šè¿‡åç«¯ä»£ç†

**åç«¯å®ç°**:
```python
# backend/routes/ai.py
@app.route('/api/v1/ai/chat', methods=['POST'])
@require_auth
def ai_chat():
    user_id = get_current_user_id()
    message = request.json.get('message')
    conversation_id = request.json.get('conversation_id')
    
    # ä¿å­˜ç”¨æˆ·æ¶ˆæ¯
    save_chat_message(user_id, 'user', message, conversation_id)
    
    # è°ƒç”¨Coze APIï¼ˆæµå¼å“åº”ï¼‰
    def generate():
        for chunk in call_coze_api_stream(message, conversation_id):
            # ä¿å­˜AIå›å¤
            if chunk.get('role') == 'assistant':
                save_chat_message(user_id, 'assistant', chunk['content'], conversation_id)
            yield f"data: {json.dumps(chunk)}\n\n"
    
    return Response(generate(), mimetype='text/event-stream')
```

**å‰ç«¯æ”¹é€ **:
```javascript
// åŸä»£ç ç›´æ¥è°ƒç”¨Coze API
// æ–°ä»£ç è°ƒç”¨åç«¯ä»£ç†
async function sendMessage(message) {
    const response = await fetch('/api/v1/ai/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${AuthService.getToken()}`
        },
        body: JSON.stringify({ message })
    });
    
    // å¤„ç†æµå¼å“åº”
    const reader = response.body.getReader();
    // ... æµå¼å¤„ç†é€»è¾‘
}
```

---

### æ¨¡å—7: æ–°é—»/å½±è§†æ¨¡å—ä»£ç†

#### 7.1 æ–°é—»ä»£ç†
**åç«¯**:
```python
# backend/routes/news.py
@app.route('/api/v1/news', methods=['GET'])
def get_news():
    # ä»RSSæºæŠ“å–æ–°é—»
    news = fetch_news_from_rss()
    return jsonify({'success': True, 'data': news})
```

**å‰ç«¯**:
```javascript
// åŸä»£ç å¯èƒ½ç›´æ¥fetch RSSï¼ˆä¼šæœ‰CORSé—®é¢˜ï¼‰
// æ–°ä»£ç é€šè¿‡åç«¯ä»£ç†
async function loadNews() {
    const response = await fetch('/api/v1/news');
    const data = await response.json();
    return data.data;
}
```

#### 7.2 å½±è§†ä»£ç†
ç±»ä¼¼æ–°é—»ï¼Œé€šè¿‡åç«¯è°ƒç”¨TMDB API

---

### æ¨¡å—8: æ•°æ®è¿ç§»åŠŸèƒ½

#### 8.1 æ£€æµ‹å¹¶è¿ç§»æœ¬åœ°æ•°æ®
```javascript
// scripts/services/migration.js
export async function migrateLocalData() {
    if (!AuthService.getToken()) {
        return; // æœªç™»å½•ï¼Œä¸è¿ç§»
    }
    
    // æ£€æŸ¥æ˜¯å¦å·²è¿ç§»
    const migrated = localStorage.getItem('data_migrated');
    if (migrated === 'true') {
        return;
    }
    
    try {
        // è¿ç§»è¯å…¸å†å²
        const localHistory = JSON.parse(localStorage.getItem('dict_history') || '[]');
        for (const item of localHistory) {
            await APIService.addDictHistory(item.word);
        }
        
        // è¿ç§»è¯å…¸æ”¶è—
        const localFavorites = JSON.parse(localStorage.getItem('dict_favorites') || '[]');
        for (const fav of localFavorites) {
            await APIService.addDictFavorite(fav);
        }
        
        // ... å…¶ä»–æ•°æ®è¿ç§»
        
        // æ ‡è®°ä¸ºå·²è¿ç§»
        localStorage.setItem('data_migrated', 'true');
        
        console.log('æ•°æ®è¿ç§»å®Œæˆ');
    } catch (error) {
        console.error('æ•°æ®è¿ç§»å¤±è´¥:', error);
    }
}
```

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### JWT Tokenè£…é¥°å™¨
```python
# backend/utils/jwt_utils.py
from functools import wraps
from flask import request, jsonify

def require_auth(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        token = request.headers.get('Authorization')
        if not token:
            return jsonify({'success': False, 'message': 'æœªæˆæƒ'}), 401
        
        try:
            token = token.replace('Bearer ', '')
            payload = jwt.decode(token, current_app.config['JWT_SECRET_KEY'])
            user_id = payload['user_id']
            # å°†user_idæ³¨å…¥åˆ°kwargs
            kwargs['user_id'] = user_id
        except jwt.ExpiredSignatureError:
            return jsonify({'success': False, 'message': 'Tokenå·²è¿‡æœŸ'}), 401
        except jwt.InvalidTokenError:
            return jsonify({'success': False, 'message': 'Tokenæ— æ•ˆ'}), 401
        
        return f(*args, **kwargs)
    return decorated_function
```

### å‰ç«¯APIæ‹¦æˆªå™¨
```javascript
// scripts/services/apiService.js
// ç»Ÿä¸€å¤„ç†401é”™è¯¯ï¼Œè‡ªåŠ¨è·³è½¬ç™»å½•
static async request(url, options = {}) {
    try {
        const response = await fetch(`/api/v1${url}`, {
            ...options,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${AuthService.getToken()}`,
                ...options.headers
            }
        });
        
        if (response.status === 401) {
            AuthService.removeToken();
            window.location.hash = '#login';
            throw new Error('è¯·é‡æ–°ç™»å½•');
        }
        
        return await response.json();
    } catch (error) {
        console.error('APIè¯·æ±‚å¤±è´¥:', error);
        throw error;
    }
}
```

---

## ğŸ“¦ æ–‡ä»¶æ¸…å•

### éœ€è¦åˆ›å»ºçš„æ–°æ–‡ä»¶

**åç«¯**:
- `backend/app.py`
- `backend/config.py`
- `backend/models.py`
- `backend/auth.py`
- `backend/routes/dictionary.py`
- `backend/routes/expressions.py`
- `backend/routes/ai.py`
- `backend/routes/news.py`
- `backend/routes/movies.py`
- `backend/services/coze_service.py`
- `backend/services/deepseek_service.py`
- `backend/services/tmdb_service.py`
- `backend/services/news_service.py`
- `backend/utils/db.py`
- `backend/utils/jwt_utils.py`
- `backend/requirements.txt`

**å‰ç«¯**:
- `scripts/modules/about.js`
- `scripts/modules/login.js`
- `scripts/services/auth.js`
- `scripts/services/apiService.js`
- `scripts/services/migration.js`

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

**å‰ç«¯**:
- `index.html` (æ·»åŠ å…³äºå’Œç™»å½•æ¨¡å—)
- `scripts/app.js` (æ·»åŠ æ–°æ¨¡å—è·¯ç”±)
- `scripts/modules/dictionary.js` (æ”¹ç”¨åç«¯API)
- `scripts/modules/expressions.js` (æ”¹ç”¨åç«¯API)
- `scripts/modules/aiAssistant.js` (æ”¹ç”¨åç«¯API)
- `scripts/modules/news.js` (æ”¹ç”¨åç«¯API)
- `scripts/modules/movies.js` (æ”¹ç”¨åç«¯API)

---

## âœ… æ£€æŸ¥æ¸…å•

### é˜¶æ®µ1å®Œæˆæ ‡å‡†
- [ ] å…³äºæ¨¡å—å¯ä»¥æ­£å¸¸æ˜¾ç¤º
- [ ] å¯¼èˆªæ å·²æ›´æ–°

### é˜¶æ®µ2å®Œæˆæ ‡å‡†
- [ ] åç«¯æœåŠ¡å™¨å¯ä»¥å¯åŠ¨
- [ ] æ•°æ®åº“è¡¨å·²åˆ›å»º
- [ ] å¯ä»¥æ³¨å†Œæ–°ç”¨æˆ·
- [ ] å¯ä»¥ç™»å½•
- [ ] JWT TokenéªŒè¯æ­£å¸¸

### é˜¶æ®µ3å®Œæˆæ ‡å‡†
- [ ] æ‰€æœ‰æ¨¡å—APIå·²å®ç°
- [ ] å‰ç«¯å¯ä»¥è°ƒç”¨åç«¯API
- [ ] æ•°æ®å¯ä»¥æ­£å¸¸ä¿å­˜å’Œè¯»å–

### é˜¶æ®µ4å®Œæˆæ ‡å‡†
- [ ] æ•°æ®è¿ç§»åŠŸèƒ½æ­£å¸¸
- [ ] æ‰€æœ‰åŠŸèƒ½æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½ä¼˜åŒ–å®Œæˆ

