# 📋 下一步操作指南

## 🎯 你现在需要做什么？

根据你的情况，选择对应的操作：

---

## ✅ 情况 1: 本地开发测试

**如果你想在本地运行和测试：**

1. **启动本地服务器**
   ```bash
   # Windows
   双击运行 start.bat
   
   # Mac/Linux
   ./start.sh
   ```

2. **访问应用**
   - 打开浏览器访问：`http://localhost:8000`
   - 所有功能都可以使用（使用本地存储）

✅ **无需任何额外配置！**

---

## 🚀 情况 2: 部署到 Railway（推荐）

### 步骤 1: 连接 Railway

1. 访问 https://railway.app
2. 使用 GitHub 登录
3. 选择 "Deploy from GitHub repo"
4. 选择你的 `AI_LL` 仓库

### 步骤 2: 添加 PostgreSQL 数据库

1. 在 Railway Dashboard 中点击 **"New"**
2. 选择 **"Database"** → **"Add PostgreSQL"**
3. Railway 会自动设置 `DATABASE_URL` 环境变量

### 步骤 3: 设置环境变量

在 Railway Dashboard → Variables 中添加：

**必需变量：**
```
JWT_SECRET=你的密钥（生成方式见下方）
```

**可选变量（AI 功能）：**
```
COZE_BOT_ID=your-bot-id
COZE_PAT_TOKEN=your-pat-token
COZE_SAT_TOKEN=your-sat-token
DEEPSEEK_API_KEY=your-deepseek-key
TMDB_API_KEY=your-tmdb-key
```

**生成 JWT_SECRET：**
```bash
# Linux/Mac
openssl rand -hex 32

# Windows PowerShell
python -c "import secrets; print(secrets.token_hex(32))"
```

### 步骤 4: 初始化数据库 ⭐

**方法 1：使用 Python 脚本（命令行，最简单）⭐**

如果你有 Python（你已经成功运行过 Python 命令），这是最快的方法：

#### 1. 获取数据库连接信息

在 Railway Dashboard 中：
1. 点击 PostgreSQL 服务（左侧的 Postgres 卡片）
2. 在右侧面板中，点击 **"Database"** 标签（不是 "Deployments"）
3. 在 "Database" 标签下，点击 **"Connect"** 按钮（通常在右上角）
4. 会显示连接信息，复制连接字符串（类似：`postgresql://postgres:password@host:port/railway`）

**注意**：如果看不到 "Connect" 按钮，也可以：
- 点击 "Credentials" 子标签，查看连接信息
- 或者查看 "Variables" 标签，找到 `DATABASE_URL` 变量

#### 2. 在 PowerShell 中执行

```powershell
# 1. 设置数据库连接（替换为你的实际连接字符串）
$env:DATABASE_URL="postgresql://postgres:你的密码@你的主机:5432/railway"

# 2. 运行初始化脚本
python database/init_db.py
```

脚本会自动：
- ✅ 连接数据库
- ✅ 读取 `database/init.sql` 文件
- ✅ 执行所有 SQL 语句
- ✅ 验证表是否创建成功
- ✅ 验证注册码是否正确

**如果提示缺少 psycopg2：**
```powershell
pip install psycopg2-binary
```

---

**方法 2：使用 DBeaver（图形界面工具）**

这是成功率最高、最简单的方法，无需安装 Node.js：

#### 1. 下载安装 DBeaver

- 下载地址：https://dbeaver.io/download/
- 选择 **Windows 64-bit Installer**（或根据你的系统选择）
- 安装时选择 "Standard" 安装即可

#### 2. 获取数据库连接信息

在 Railway Dashboard 中：

1. 点击 PostgreSQL 服务（蓝色大象图标）
2. 点击右上角的 **"Connect"** 按钮
3. 会显示连接信息，类似：
   ```
   Host: xxxxx.railway.app
   Port: 5432
   Database: railway
   User: postgres
   Password: xxxxx
   ```
   **或者**直接显示连接字符串：
   ```
   postgresql://postgres:password@host:port/railway
   ```

#### 3. 在 DBeaver 中连接数据库

1. 打开 DBeaver
2. 点击左上角 **"New Database Connection"** 按钮（插头图标）
3. 选择 **PostgreSQL**，点击 **Next**
4. 填写连接信息：
   - **Host**: 从 Railway 复制的 Host（如 `xxxxx.railway.app`）
   - **Port**: `5432`（或 Railway 显示的端口）
   - **Database**: `railway`（或 Railway 显示的数据库名）
   - **Username**: `postgres`（或 Railway 显示的用户名）
   - **Password**: Railway 显示的密码（点击 "Show password" 查看）
5. 点击 **"Test Connection"** 测试连接
   - 如果提示下载驱动，点击 **Download**
   - 连接成功后点击 **Finish**

#### 4. 执行 SQL 初始化脚本

1. 在 DBeaver 左侧，展开你的数据库连接
2. 右键点击数据库名称 → **SQL Editor** → **New SQL Script**
3. 打开项目中的 `database/init.sql` 文件（用记事本或 VS Code 打开）
4. **全选并复制**所有内容（Ctrl+A, Ctrl+C）
5. 粘贴到 DBeaver 的 SQL 编辑器中（Ctrl+V）
6. 点击工具栏的 **"Execute SQL Script"** 按钮（或按 **F5**）
7. 等待执行完成，底部应该显示 "Success" 或类似消息

#### 5. 验证初始化成功

在 DBeaver 左侧：

1. 展开数据库连接 → **Schemas** → **public** → **Tables**
2. 应该能看到 9 个表：
   - ✅ users
   - ✅ registration_codes
   - ✅ dict_history
   - ✅ dict_favorites
   - ✅ vocab_progress
   - ✅ expressions
   - ✅ expression_favorites
   - ✅ ai_chat_history
   - ✅ movie_watchlist

**验证注册码：**

在 SQL 编辑器中执行：
```sql
SELECT code, unlimited_use, is_active FROM registration_codes;
```

应该能看到：
```
code           | unlimited_use | is_active
---------------|---------------|----------
202300210001   | true          | true
```

---

**其他方法（备选）：**

如果 DBeaver 不工作，可以尝试：
- **TablePlus**：https://tableplus.com/ （界面更美观）
- **Railway CLI**：需要先安装 Node.js（https://nodejs.org/）

### 步骤 5: 等待部署完成

Railway 会自动检测到环境变量变化并重新部署（2-5分钟）

### 步骤 6: 验证部署

1. **检查健康状态**
   - 访问 `https://your-project.railway.app/health`
   - 应该返回：`{"status": "ok"}`

2. **测试注册功能**
   - 打开应用
   - 点击注册
   - 使用注册码：`DEMO2024`
   - 填写用户名和密码
   - 应该能成功注册

3. **测试登录功能**
   - 使用刚才注册的账号登录
   - 应该能成功

---

## 📝 环境变量检查清单

确认以下变量已设置：

- [ ] `DATABASE_URL` - ⚠️ 需要添加 PostgreSQL 服务（自动设置）
- [ ] `JWT_SECRET` - ⚠️ 需要手动设置（必需）
- [ ] `COZE_BOT_ID` - 可选（AI 助手功能）
- [ ] `COZE_PAT_TOKEN` - 可选（AI 助手功能）
- [ ] `COZE_SAT_TOKEN` - 可选（AI 助手功能）
- [ ] `DEEPSEEK_API_KEY` - 可选（新闻关键词、语用生成）
- [ ] `TMDB_API_KEY` - 可选（电影数据）

---

## 🔧 如果遇到问题

### 问题 1：DATABASE_URL 未设置

**解决**：
1. 确认已添加 PostgreSQL 服务
2. 在 Railway Dashboard 中检查主应用的环境变量
3. 如果看不到，重新添加 PostgreSQL 服务

### 问题 2：数据库连接失败

**解决**：
- 检查 PostgreSQL 服务是否正常运行
- 确认 `DATABASE_URL` 格式正确

### 问题 3：表已存在错误

**解决**：
- 这是正常的，可以忽略
- 或者删除现有表后重新初始化

---

## 🎉 完成！

完成以上步骤后，你的应用就可以：
- ✅ 用户注册和登录
- ✅ 跨设备同步词典历史
- ✅ 所有 AI 功能正常工作

---

**最后更新**：2024-12-19

